name: Branch Naming Convention Check
run-name: Branch Name Check for ${{ github.head_ref }}

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Debug PR information
        run: |
          echo "ðŸ” Debug Information:"
          echo "  â€¢ Head ref: ${{ github.head_ref }}"
          echo "  â€¢ Base ref: ${{ github.base_ref }}"
          echo "  â€¢ Event name: ${{ github.event_name }}"
          echo "  â€¢ Action: ${{ github.event.action }}"
          echo "  â€¢ PR number: ${{ github.event.pull_request.number }}"
          echo "  â€¢ PR state: ${{ github.event.pull_request.state }}"
          echo "  â€¢ PR draft: ${{ github.event.pull_request.draft }}"

      - name: Check if PR targets develop
        id: check_target
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the current base branch from GitHub API (not the context variable)
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          echo "Fetching current PR information from GitHub API..."
          CURRENT_BASE=$(gh api "repos/${REPO}/pulls/${PR_NUMBER}" --jq '.base.ref')

          echo "Context base ref: ${{ github.base_ref }}"
          echo "Current base ref: $CURRENT_BASE"

          if [ "$CURRENT_BASE" = "develop" ]; then
            echo "âœ… PR targets develop branch - proceeding with branch name check"
            echo "should_check=true" >> "$GITHUB_OUTPUT"
          else
            echo "â„¹ï¸ PR targets $CURRENT_BASE branch - skipping branch name check"
            echo "should_check=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check branch name
        if: steps.check_target.outputs.should_check == 'true'
        run: |
          branch_name="${{ github.head_ref }}"
          echo "Checking branch name: $branch_name"

          # Allow system/promoter branches to bypass naming checks
          case "$branch_name" in
            staging|staging-promoter|production-promoter)
              echo "System branch '$branch_name' â€“ skipping naming check"
              exit 0
              ;;
          esac

          if [[ $branch_name =~ ^(feature|bugfix|hotfix)/[a-z0-9_\-]+$ ]]; then
            echo "Branch name follows the naming convention: <type>/<branch-name>"
            echo "Branch name is valid: $branch_name"
          else
            echo "Branch name does not follow the naming convention!"
            echo ""
            echo "BRANCH NAMING REQUIREMENTS:"
            echo "  â€¢ Must start with 'feature/', 'bugfix/', or 'hotfix/'"
            echo "  â€¢ Must contain only lowercase letters, numbers, underscores, and hyphens"
            echo "  â€¢ Examples:"
            echo "    - feature/user_authentication"
            echo "    - bugfix/performance_optimization"
            echo "    - hotfix/critical_fix"
            echo ""
            echo "TO FIX YOUR BRANCH NAME:"
            echo "  1. Rename your current branch:"
            echo "     git branch -m $branch_name feature/your_feature_name"
            echo ""
            echo "  2. Delete the old remote branch:"
            echo "     git push origin --delete $branch_name"
            echo ""
            echo "  3. Push the renamed branch:"
            echo "     git push origin feature/your_feature_name"
            echo ""
            echo "  4. Update your local branch to track the new remote:"
            echo "     git branch --set-upstream-to=origin/feature/your_feature_name"
            echo ""
            echo "Replace 'your_feature_name' with a descriptive name for your feature"
            exit 1
          fi
